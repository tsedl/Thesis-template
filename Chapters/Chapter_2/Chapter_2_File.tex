%=== Chapter Two ===
\chapter{Dynamic Platooning for Automated Guided Vehicles (AGV)}



\section{Introduction}
AGV typically have their motion restricted to a roadmap connecting pick and drop locations \cite{Cardarelli2017}. This reduces the search space to make conflict free routing of multiple vehicles between different origins and destinations feasible. \cite{Digani2015} proposes a two level decomposition of the problem with the detailed roadmap at the bottom and a higher level abstraction of zones around each intersection above. The conflict avoidance is handled with local information within each zone. The routing decisions are made at high level, utilizing a traffic model where each intersection has a fixed capacity (number of vehicles). 
 
%\section{INTRODUCTION}
Coordinated conflict-free motion of a number of mobile robots in order to complete a material transfer task is important in the operation of fleets of AGV (Autonomous Guided Vehicles) used in flexible manufacturing and automated warehouses \cite{Vis2006} and \cite{Dotoli2019}. A crucial sub-problem is conflict resolution between multiple AGVs, without control of task assignment or scheduling.

It is shown, in \cite{Digani2019}, that platooning provides superior throughput to the earlier reservation based systems, and that if a solution exists it is optimal, but not that a solution exists on all roadmaps. More importantly a set of conditions which must hold for a solution to exist, is not given. The consensus algorithm in \cite{Tadano2019} also shows improved throughput in concert with a scheduling approach, but does not prove convergence. 
An example of a resolution complete algorithm based on spatial reservation is \cite{Draganjac2020}. Neither per-intersection optimal platooning nor per-vehicle consensus have been proven complete. The lack of guarantees is an important limitation of platooning methods for collision avoidance. The research gap identified is the lack of investigation into the range of motion conflict situations that can be resolved with platooning methods.

\section{Literature Review}
AGV motion coordination can be posed as a variation of the Multiple Vehicle Routing Problem with the addition of challenging spatio-temporal constraints preventing collisions between each vehicle, as well as the usual timing and capacity constraints \cite{Miyamoto2016}. In \cite{Li2017}, solutions are classified into centralized, decentralized and decoupled approaches. Each approach may be either optimal or heuristic based on whether or not they find the global minimum of some objective function. 

It is also possible to classify approaches based on the limitations they place on the state space of each AGV. Most practical methods incorporate both obstacle avoidance constraints and differential motion constraints into some sort of roadmap. This is often a graph with vertices at key points in the reachable state space, connected by edges representing feasible motion between them. The effect of increasing resolution on path quality (measured by reduction in the length of the shortest path) and computation time are studied in \cite{VanDenBerg2005}. 

Interest in centralized methods which plan in the full state space all of the vehicles was renewed by the development of effective numerical tools for operations research able to solve large combinatorial problems to optimality. Notably \cite{Richards2002} found trajectories for aircraft using a linear approximation to the dynamics and obstacle constraints, allowing the use of Mixed Integer Linear Programming. The contribution of \cite{Li2017} is to describe a new centralized, optimal method which scales well, finding a solution to the nonlinear-program for 10 vehicles in just a few seconds using an interior point method. However, size of the combined state space explodes as more vehicles are included so centralized methods are difficult to scale up to large numbers of vehicles.

Many types of decoupled methods have been developed because breaking the problem down into sub-problems is one way to reduce computation time for practical applications. Early methods of this type were based on timed petri nets \cite{Dotoli2004} and agent based models \cite{Singh2002}. Decoupled methods may sacrifice completeness (that a solution is found if one exists) in exchange for reduced average run-time. In \cite{Sanchez2002}, this was shown to cause practical difficulties in the spot-welding task studied. Spot welding requires close formation control of six vehicles, and the decoupled method frequently failed to find a solution. In \cite{Peasgood2008}, decoupled planning (incomplete) is compared with a new multi-phase heuristic, which is complete, for 50 robots on a tunnel map and 150 on an outdoor map. Decoupled planning was consistently faster in execution and produced shorter paths for lower vehicle density however it failed to find any valid paths at all for high vehicle density (25 or more robots in tunnels and 75 or more outdoors). The multi-phase heuristic, being complete, found a solution in every test case. 

More recently, \cite{Yu2013} addressed the lack of optimality in decoupled methods operating on graphs. Optimal conflict-free motion is posed as a large Integer Linear Program. Resolution complete general purpose algorithms are used to solve it for 150 robots in just over 10 seconds. The lattice/graph construction has recently been developed further to ensure kinematic constraints are met and improve coverage of state space around obstacles \cite{Yu2018}. In \cite{Miyamoto2016}, the combined problem of DCFVRP (Dispatch and Conflict-Free Vehicle Routing Problem) for flexible manufacturing is formulated as an integer program and two different decoupled algorithms are presented to solve it: local search and random search. Neither of the proposed algorithms is complete but local search found more valid solutions in the 10 random examples tested, all involving three vehicles.

Decentralized control is another option to decompose large scale problems which take too long to solve centrally \cite{Bakule2008}. Although limiting the information available to each decision maker can make reasoning about collective behavior more difficult, various attempts to decentralize conflict-free routing have been made. 
In the field of conflict free routing for mobile robots, \cite{Draganjac2016} presents a solution which generates a graph representation of the free space - effectively a roadmap - with the property of `collision-avoidability.' This means that every node on the critical path must be at most one move away from a node that does not obstruct the critical path. The critical path is defined as the union of all the shortest paths between pick/drop locations in the roadmap. During decentralized planning, AGVs attempt to reserve `private zones' consisting of the node on the critical path along with all adjacent collision avoidance nodes. Each AGV has an identical roadmap, plans the shortest path to its own goal and negotiates with those nearby based on a numeric priority to reserve the nodes in its own path. An AGV requests those in its path move to their collision avoidance node, and those with a lower priority will do so. Proof is given of correctness, that deadlocks are avoided, but throughput is sub-optimal with low priority vehicles frequently forced to stop and wait. %Another decentralized method based on sequential reservations is given by \cite{Walenta2017}, without the concept of 'private zones' to avoid deadlocks however. 
An alternative decentralized solution, based on a roadmap with two levels of detail is summarized in \cite{Sabattini2018}. Conflict-free routing primarily takes place at the most detailed level, based on prioritized roadmap reservation with local negotiation to guarantee correctness \cite{Digani2014}.  In \cite{Digani2019}, the speed of the approaching AGV is optimized at each intersection in a similar way to centralized intersection platooning. The result is higher throughput as time consuming negotiation is avoided in most cases.      

Congestion effects are represented by link performance functions in the approximate level graph. Intersections have a generalized cost which increases exponentially up to a fixed capacity which identified by parameter tuning, An optimal task scheduling approach based on the Hungarian Algorithm is used to solve the full DCFVRP in \cite{Sabattini2015a} and \cite{Sabattini2018}. Traffic delays are a type of emergent behaviour and modelling is challenging even in a completely automated system. This is the contribution of \cite{Street2020} which introduces the PRT (Probabilistic Reservation Table) to summarize the plans of robots including uncertainty so it can be in task scheduling. This approach is compared with a reservation based centralized planner as a baseline, in a simulation with 5 robots using a low level motion controller from ROS (Robot Operating System) which often fails at when two robots plan interfering paths. Congestion aware planning leads to fewer failures of the low level controller than independent planning but more than centralized planning. A more convincing comparison would be with a congestion aware planner using a deterministic congestion model instead of the PRT, but this is not reported.

Intersection control, based on platooning, is a concept developed for the operation of anticipated CARVs (Connected and Autonomous Road Vehicles). A recent review of approaches for intersection and merging coordination is given in \cite{Rios-Torres2017}. Centralized optimization approaches improve on early ideas like First-Come-First-Served spatial reservation from \cite{Dresner2008} by minimizing fuel consumption, but the rapid increase in state space with larger numbers of vehicles will need to be addressed before large scale adoption. The communication channel connecting every vehicle with the central controller introduces a single point of failure, the reliability effect of which is difficult to evaluate in existing simulations. Moreover there are few CARVs available making a practical experiment unfeasible in most cases. Attempting to address these limitations are decentralized methods such as fuzzy-logic, virtual vehicle platooning and invariant set approaches. Notably the conditions for solutions to exist which minimize energy consumption are given in \cite{Malikopoulos2018}.

Recently \cite{Tadano2019} described an approach to the DCFVRP for flexible manufacturing based on dynamic platooning with vehicle-to-everything messaging and consensus speed control, resulting in a decentralized heuristic solution with some additional rules to ensure correct behavior and avoid deadlocks by adding a reservation protocol for some parts of the roadmap. This was combined with feedback from the queue length at different workstations in a traffic management heuristic. Simulation results show an impressive improvement compared to the first-come-first-served scheduling approach meant to represent industry standard practice.   

A promising approach for intersection control applied to AGV is given in \cite{Digani2019}. As the paths are not modified, only the speed adjusted deadlocks are proved impossible. However, a backup system based on negotiation is still required because the problem is non-convex suggesting a feasible solution may not be found in time for certain roadmap and traffic combinations. The consensus based platooning method for local collision avoidance used in \cite{Tadano2019} is unusual in the AGV domain. That work makes no claims about completeness, but does consider the trivial consensus where all vehicles stop in a deadlock. In \cite{Zhang2018}, a recent system for conflict avoidance based on time headway is shown to significantly reduce intersection crossing time and allow more vehicles to operate in the same floor-space compared to a traditional reservation based strategy. Of these different approaches to platooning for AGV coordination, the quadratic constraints of \cite{Digani2019} are the closest to acheiving the certainty the would be required to build a distributed coordination scheme.
%\section{METHODOLOGY}
%
%With existing methods, a backup system is needed to prevent collisions in exceptional cases, as there is no proof of completeness of the main algorithm. A proof might be possible placing certain conditions on the traffic flow or the roadmap layout, but this is left for further work. Instead we focus on simulation to identify situations where convergence is more or less reliable. This will help to identify sites where the potrential throughput benefiits can be realized because the slower fallback option will be needed less often. It may also highlight situations in which current methods frequently fail, and help to inform modified algorithms to address these cases.  

%\begin{figure}[htbp]
%\centerline{\includegraphics[width=1.0\linewidth]{single-track-layout.png}}
%\caption{Single-track grid layout}
%\label{fig:single-track-layout}
%\end{figure}
%%[htbp]
%%\scalebox{0.5}[heightscale]{}
%%\resizebox{1.0\linewidth}{1.0\linewidth} %only for \include{graphics}
%%\centerline{\includegraphics[width=1.0\linewidth]{single-track-layout.png}}
%\begin{figure}[htbp]
%\centerline{\includegraphics[width=1.0\linewidth]{highway-layout.png}}
%\caption{Highway grid layout.}
%\label{fig:highway-layout}
%\end{figure}

%To test the success rate in finding a solution from a variety of initial conditions, we assume all AMR follow their planned trajectory exactly and look for cases where the platooning algorithm did not converge before the intersection, leading to a collision. The trajectory of each AMR must be tracked over time at a relatively high frequency, such as 10hz. Circular bodies of fixed radius can be assumed to make collision checking straightforward. Lateral dynamics can be neglected by assuming the path following controller is successful and tracks the path exactly.  Second order dynamics enable comparison of energy consumption resulting from platooning. Deadlocks and Live-locks can both be checked based on a time threshold for a vehicle to complete a job e.g. the transfer time plus the length of time it would take a vehicle to traverse the entire roadmap. If either is exceeded the simulation state should be recorded for further analysis. 
%
%In order to do this a number of realistic roadmaps are required, along with sensible parameters for vehicle size, acceleration and top speed. These can be estimated based on the literature such as \cite{Boysen2019} and \cite{Dotoli2019}. Important classes of roadmap which may be representative include grids, one-way aisles and two-way aisles.  such as those in Figures \ref{fig:single-track-layout} and \ref{fig:highway-layout}. 


%Conflict avoidance is only one part of the DVFVRP problem, the job assignment method has a profound affect on the frequency and complexity of the motion conflicts which need to be resolved. For this reason it is important to track genuine transfer jobs, assigned to a fixed number of `physical' vehicles (they do not appear and disappear at convenient times and move only according to a second order dynamic model). There is a separate question of which job scheduling algorithm and associated traffic model is best suited to each conflict-resolution method which we will not address here. For simplicity of exposition and ease of reproduction we will use a nearest-first-come-first-served scheduling approach to create traffic for both conflict-resolution methods. This is sufficient that the  number of transfer tasks completed can be tracked in a simulation of `physical' vehicles. Improvement of productivity using a traffic model and the Hungarian algorithm (e.g. \cite{Sabattini2015a}) is left for further work. We know of no reason it would benefit one method in particular.
\section{Simulation}

Platooning with speed choice by a centralized controller was implemented with a vehicle to intersection messaging scheme. The full site is divided into zones, each one containing a single intersection. Each AGV in the fleet has a copy of the roadmap which is  static. The fleet controller interfaces with the warehouse management system to get the next material transfer job, consisting of a pick location and a drop location. All jobs are assumed to be of unit size and each AGV has a capacity of one unit. With these assumptions, a straightforward policy is to assign the next job to the AGV nearest to the pick location - first-come-first-served scheduling. When an AGV receives a new job, it finds the shortest path through the roadmap using the Floyd-Warshall algorithm \cite{Djojo2013}. Next it must send its planned path to the intersection controller for the zone it currently occupies. The intersection controller stores the plan and current position of every AGV approaching the conflict point of the intersection. Every time it receives a new plan it must recalculate the approach speed for every approaching AGV to minimize total travel time without collision. This will happen every time an AGV enters the zone from somewhere else, or an AGV within the zone is assigned a new job.

%\begin{figure}[ht]
%\centering
%\includegraphics[width=\linewidth]{intersection_layout_trim}
%\caption{Intersection layout shown in SUMO NETEDIT tool \cite{dlr2016}}
%\label{fig:layout}
%\end{figure}
\begin{figure}[ht]
\centering
\includegraphics[width=0.9\linewidth]{intersection_topo}
\caption{Intersection layout with two conflicting routes.}
\label{fig:layout}
\end{figure}

The intersection controller was implemented based on \cite{Digani2019}. The surrounding lanes are first discretized into segments. The intersection shown in Figure \ref{fig:layout} is divided into six segments, each of length 10 meters. The critical segments are the two that cross in the center. There are two routes defined, one starting on the left and traveling to the right and the other starting at the bottom and traveling up. One AGV takes route 1 and the other takes route 2. If they both travel at maximum speed they will collide in the center.

The dynamic model for each AGV assumes they are able to exactly follow the path, and attempt to reach the target speed for each segment subject to a limited rate of acceleration of $a m/s^2$. 

\begin{figure}[ht]
\centering
\includegraphics[width=0.9\linewidth]{SystemSetup3.pdf}
\caption{Messages exchanged by participants approaching intersection.}
\label{fig:system_setup}
\end{figure}

The ApproachPlan message sent by the AGV contains a sequence of segments which it intends to traverse, along with its current distance along the first one.  The flow of messages is shown in Figure \ref{fig:system_setup}. The SpeedList sent by the intersection controller contains the optimal speed for every segment in the plan. The speeds can be found with the nonlinear program in Equation \ref{eq:qp_speeds}. 

\subsection{Motor Dynamic and Electrical Model}
The simulated AGV are based on a small payload 100kg total mass, with a maximum speed of 10m/s and peak acceleration of 5m/s$^2$, allowing them to stop safely within 10 metres. The intersection controllers use a constant acceleration model to calculate the time and space deadlines they pass to the AGV. To make the simulation test worthwhile a simulation model with slightly more complexity was used to evaluate the performance.


The brushless DC electric motor used in \cite{Racewicz2018} has suitable properties to propel a 100kg battery powered vehicle. A DC motor can be modelled by the steady state equivalent circuit shown in Figure \ref{fig:dc_circuit} which is well known, for example see \cite{Hughes2008}. 

\begin{figure}[ht]
	\centering
	\includegraphics[width=0.9\linewidth]{dc_circuit.eps}
	\caption{Steady state equivalent circuit for a DC motor.}
	\label{fig:dc_circuit}
\end{figure}

This simple circuit leads to the relationship between current and internal resistance given by Equation \ref{eq:steady_state}.
\begin{equation}
V_{cc} = E_D + I_a R_a
\label{eq:steady_state}
\end{equation} 
It should be noted that the brushless DC motor is sometimes grouped with AC machines such as the induction motor due to its varying excitation \cite{Sarlioglu2016}. The coils are energised in order to keep the magnetic field at 90 degrees to the field generated by the permanent magnets mounted on the rotor. 

The field strength of the magnets, the number of poles and the number turns of the armature coils can be captured in the motor constant $k_T $ relating torque to armature current.

\begin{equation}
\tau = k_T I_a
\label{eq:torque_constant}
\end{equation} 

\begin{equation}
 E_D = \frac{rpm}{k_e}
\label{eq:emf_constant}
\end{equation} \\

 There are numerous loss sources in an electric motor such as winding resistance, flux leakage, eddy currents in the core and so on \cite{Sarlioglu2016}. By using real-world measured mechanical power output and electrical input, an equivalent winding resistance $R_a$ for the simple model can be found. The parameters are shown in Table \ref{tab:motor_params}. 
 
 \begin{table}
 	\caption{Motor parameters used in simulation.}
 	\label{tab:motor_params} 
 	\centering
 	\begin{tabular}{ |c|c| }
 		\hline
 		$k_v$ [rpm/v]& 6 \\ 
 		$k_T$ [Nm/A] & 1.53 \\ 
 		$P_{mech}$@375rpm [kW] & 3.6 \\ 
 		$P_{elec}$@375rpm [kW]& 6.37 \\
 		*$R_a$ [Ohms] & 1.0 \\
 		\hline
 	\end{tabular}
 \end{table}

\subsection{Air Resistance}
In addition to the resistive losses in the motor windings losses due to air resistance were also modelled. AGVs  typically operate at low speed <3m/s, hence the unaerodynamic shape of many models. However, the target speed of 10m/s is quite high around 30 miles per hour and drag could become significant. 

The drag coefficient $C_{drag}$=1 for a cuboid shape was used, taken from \cite{Toolbox2004}. The frontal area $A$ of 1m$^2$ is consistent with a box shape for maximum load carrying capacity. The density of air at room temperature is close to 1kg/m$^3$.

\begin{equation}
F_D = C_{drag} \rho v^2 A
\end{equation} 


\subsection{Arrival Distribution}
%*see Arrival Distribution for Intersection Simulation (Sources!).docx
Previous work in road traffic modelling has used a variety of point distributions to model arrivals. A good summary is given in \cite{Knoop2020} or the chapter on Microsimulation in \cite{Sheffi1985}. 

\subsubsection{Learning from Road Transport Models}
\begin{figure}
	\centering
	\includegraphics[width=0.9\linewidth]{poisson_cdf.eps}
	\caption{Cumulative Distribution Function of arrivals following a Poisson distribution.}
	\label{fig:poisson_cdf}
\end{figure}
One option is to assume arrivals at a point are completely independent of each other, but occur at an average rate for the time of day which has been measured by inductive loop placed in the road. These assumptions lead to a Poisson distribution such as that shown in Figure \ref{fig:poisson_cdf}. This can be generated computationally by drawing a sequence of numbers from a uniform distribution and applying Equation \ref{eq:poisson_delta} to compute the time delta until the next arrival. To validate the arrivals drawn in this way, we check the log plot of the frequency against time delta is linear and the median is equal to the specified rate as shown in Figure \ref{fig:1_minus_ln_cdf_arr}.   
\begin{figure}
\centering
\includegraphics[width=0.9\linewidth]{ln(1-cdf)poisson_arr.eps}
\caption{Log Cumulative Distribution Function of arrivals with linear fit.}
\label{fig:1_minus_ln_cdf_arr}
\end{figure}


The assumption that arrivals are independent does not hold if traffic density is high. This is because vehicles slow down to keep a safe distance from the one in front of them. The simplest modification to the poisson distribution to account for this is to discard time deltas which violate the specified safe headway, leading to the shifted exponential distribution. A scatter plot of times from this distribution is shown in Figure \ref{fig:poisson_shifted_scatter}. Now the arrivals will always be realistic in the sense vehicle will not overlap/arrive unsafely but the variance will be smaller. The two parameters the average arrival rate $\lambda$ and the minimum safe headway $\tau$ together control the variance. This is because the median of the distribution must be $\lambda$, so if $1/\tau$ is close to $\lambda$ the variance must be very small.   

\begin{figure}
\centering
\includegraphics[width=0.9\linewidth]{poisson_shifted_scatter.eps}
\caption{Scatter plot of 500 arrival time deltas drawn from a shifted exponential distribution with a minimum headway of 0.2 seconds.}
\label{fig:poisson_shifted_scatter}
\end{figure}
\begin{figure}
	\centering
	\includegraphics[width=0.9\linewidth]{ln(1-cdf)poisson_arr.eps}
	\caption{Log Cumulative Distribution Function of arrivals with linear fit.}
	\label{fig:1_minus_ln_cdf_arr}
\end{figure}

\subsubsection{Unique Features of AGV Traffic}
The arrival distribution corresponds to the properties of AGV traffic satisfying the following assumptions:
\begin{itemize} 
\item{More than one AGV is permitted to enter the same link if they are travelling in the same direction.}
\item{Entry to links in the roadmap is denied if the number already present on the link reaches a fixed capacity}
\item{Car-following behaviour within the link is governed by the frontal safety system on board each AGV. This provides an outer (warning) zone which, if tripped, the AGV will slow to $w$m/s at $a_w$m/s and an inner zone (emergency)), which if tripped the vehicle will come to a complete stop at $a_e$m/s, where $|a_e|$ > $|a_w|$}
\item{The capacity of a link is the number of AGVs which would fit without the inner front safety zone of each being tripped by the one in front. This can be calculated for $n$ AGVs each with safety zone length $d_e$ as $n_c = n\dot d_w$}
\item{Every AGV is informed whether it is able to proceed before it reaches the end of its current link. The AGV will keep slowing down to stop at the end, until it is informed there is space on the next link, at which point it will accelerate to full speed. }
\end{itemize}

According to these assumptions, a suitable model is the shifted exponential, with a minimum headway based on the size of the AGV safety zone. 

\subsubsection{Arrival Variation Based on Approach Lane Occupancy}
Another consideration is how the traffic on the approach lanes should feed back into the arrival times. Based on the counting semaphore for each link assumption, this can be modelled with two queues at the entryway. The lane queue and the busy queue. If the occupancy of the lane is less the $n_c$, new arrivals are added to the lane queue at full speed, in the simulation interval exceeding their point arrival time, at a position they would have reached by the simulation time. If the occupancy of the lane is more than $n_c$ new arrivals are added to the back of the busy queue. At the next time step where $n<n_c$, the AGV at the front of the busy queue is moved onto the lane. The arrival speed is reduced according to acceleration rate $a_W$ based on the time between the arrival and the time step where is can proceed. For longer time periods the new arrival will have zero speed. All arrivals which were not at the front of the busy queue will arrive at the warning speed $v_w$=0.3m/s. 


\subsection{Division of Responsibility Between Intersection and AGV Controllers}
With different signal-free intersection control approaches, the functionality carried out centrally by the fixed-server compared to that by the mobile AGV varies significantly. Of particular interest are the interfaces used by Digani et al \cite{Digani2019} where the intersection provides average speeds for discrete segments, and the one used by Levin and Rey \cite{Levin2017} where the reservation message sent by the intersection contains the arrival time at the conflict point. 

The arrival time at the conflict point is similar to a widely used waypoint interface. As the time is the important quantity for ensuring collisions are avoided this interface seems more sensible. However, on its own it is not sufficient to ensure FIFO behaviour of AGVS approaching in the same lane. Many studies assume an external mechanism for car-following based on local sensors such as the Intelligent Driver Model in \cite{He2020}.  

Without a car-following or platooning approach locally on the AGV, simple methods to manage cross traffic can easily fail to maintain FIFO ordering. This problem is often encountered in traffic simulation with cellular models and there are various techniques to avoid it without generating a trajectory for each vehicle \cite{Carey2014}. 

\cite{Levin2017} and \cite{Digani2019} do not mention any local car following behaviour and seek to avoid all collisions by the centralised application of constraints. This makes it difficult to compare them to a semaphore based intersection controller, unless car following is used in combination with semaphore access control.  

\section{Methods For Zone-Based Intersection}
\subsection{Intersection Controller Objective}
The objective is to minimize $J_T$ the total travel time for all vehicles. It is convenient for exposition to optimize over the inverse of speed of each segment $\phi_k = 1/v_k$. Vehicle $i$ submits a plan containing $m_i$ segments before the conflict and $n_i$ segments in conflict. The control model is based on the average speed of each approaching AGV over each segment. This is to simplify the description of the intersection controller, and assist analysis. More sophisticated motion models could take the place of  Equation \ref{eq:omega_min} and  Equation \ref{eq:omega_max} to create a similar type of problem with a convex travel time objective and non-convex constraints.   
The parameters for one vehicle can be collected in the vector $\bm{\phi}_i$ as shown in Equation \ref{eq:phi_i}
\begin{equation}
\bm{\phi}_i =  [\phi_{1}, ..., \phi_{(m_i + n_i)}]^T \\
\label{eq:phi_i}
\end{equation}
The parameters for $p$ vehicles each traversing $(m_i + n_i)$ segments are assembled into a vector as in Equation \ref{eq:parameters}
\begin{equation}
\bm{\phi} = [\bm{\phi_{1}}^T, ..., \bm{\phi}_{p}^T]^T \\
\label{eq:parameters}
\end{equation}
Similarly, the length of each segment in plan $i$ can be arranged into a vector 
\begin{equation}
\bm{d}_i = [d_{1}, ..., d_{(m_i + n_i)}]^T \\
\label{eq:d_i}
\end{equation}
and collected  for $p$ vehicles into a vector as in Equation \ref{eq:d}.
\begin{equation}
\bm{d} = [\bm{d_{1}}^T, ..., \bm{d}_{p}^T]^T \\
\label{eq:d}
\end{equation}
This leads to the minimum travel time objective in Equation \ref{eq:qp_speeds}. 
\begin{equation}
\begin{array}{c}
\min \limits_{\bm{\phi}} \bm{J_T} = \bm{d}^T \bm{\phi} \\
\textrm{subject to}\\
 \bm{\phi}_{max} > \bm{\phi} > \bm{\phi}_{min} \\
 \bm{\phi}^T\bm{H}_{i,j}\bm{\phi} > \bm{0} \quad \forall i,j \in [1,p] \quad \textrm{with } j>i \\
\end{array}
\label{eq:qp_speeds}
\end{equation}

The condition $j>i$ in Equation \ref{eq:qp_speeds} indicates that the number of constraints varies with the number of vehicles $p$ as $\frac{p(p-1)}{2}$. This corresponds to one constraint between each pair of approaching AGVs.

\subsection{Intersection Controller Timing Constraints}
By definition, each intersection has a single conflict zone, the union of all segments which intersect there. This makes it possible to express the constraint that vehicles do not collide in terms of time. Vehicle $i$ arrives at the first conflicted segment $\omega_i^{min}$ and departs from the last at $\omega_i^{max}$. The following three subsections set out three alternative ways of expressing the collision avoidance constraints which have been evaluated. 
The arrival time is given by Equation \ref{eq:omega_min}. Considering average speeds, the departure time $\omega_i^{max}$ is also linear, this is given by Equation \ref{eq:omega_max}. 
\begin{equation}
\omega_i^{min}  = \sum_{k=1}^{m_i} \bm{d}_i [k] \bm{\phi}_i [k] = \bm{e}^T \bm{\phi}_i
\label{eq:omega_min}
\end{equation}
where %$\bm{e}[k] = \bm{d}_i[k] \forall k <m_i, otherwise 0$
\begin{equation}
\bm{e}[k] = \left\{
\begin{array}{cc}
\bm{d_i}[k] & \forall k <m_i \\
0 & \textrm{otherwise} \\
\end{array}
\right.
\end{equation}  and $m_i$ is the number of segments on the path of vehicle $i$ before arrival at the conflicted segment. 
\begin{equation}
\omega_i^{max}  = \omega_i^{min} + \sum_{i=1}^{n_i} \bm{d}_i [k] \bm{\phi}_i [k] = \bm{f}^T \bm{\phi}_i
\label{eq:omega_max}
\end{equation}
where 
\begin{equation}
\bm{f}[k] = \left\{
\begin{array}{cc}
\bm{d_i}[k] & \forall k <m_i+n_i \\
0 & \textrm{otherwise} 
\end{array}
\right.
\end{equation}
 and $n_i$ is the number of segments on the path of vehicle $i$ which are conflicted. Note that Equations \ref{eq:omega_min} and \ref{eq:omega_max} only depend on the $\bm{\phi}_i$ of vehicle $i$. 



\subsubsection{Linear FIFO Constraints}
\label{sec:fifo_constraints}
If the order in which the AGV cross the conflict zone is fixed to be First-In-First-Out, the timing constraint is linear. For a pair where the leader enters the conflict at $t_i$ and takes $\Delta t_i$ seconds to cross at maximum speed the condition for entry time of the follower $t_{i+1}$ given by Equation \ref{eq:entry_time}.

\begin{equation}
	-t_{i} + t_{i+1}	\leq	\Delta t_i
	\label{eq:entry_time} 
\end{equation} 

There is one constraint between each adjacent pair so $p-1$ constraints total for $p$ vehicles. These can be expressed in the form $\bm{A}_{ub}\phi \leq \bm{b}_{ub}$ as in Equation \ref{eq:fifo}. This is correct for two AGV arranged in distance order, each traversing one approach and one conflict segment. 



\begin{equation}
\left[ 
\begin{array}{ccccc}
-d_1 & d_2 & \bm{0}\\
\vdots & \ddots & \vdots \\
\bm{0} & -d_{p-1} & d_p\
\end{array} \right]
\left[
 \begin{array}{c}
  \phi_1 \\ \vdots \\ \phi_p
 \end{array} \right]
\leq
\left[ 
\begin{array}{c}
\Delta t_1 \\
 \vdots \\
 \Delta t_{p-1}
\end{array} \right]
\label{eq:fifo}
\end{equation}

 The timing constraint between each pair of vehicles can be expressed with a modulus operator as in Equation\ref{eq:timing}.
\begin{equation}
|\alpha_i - \alpha_j| > \beta_i + \beta_j
\label{eq:timing}
\end{equation}

Here 
\begin{equation}
\alpha_i  = \omega_i^{max} + \omega_i^{min}
\label{eq:alpha}
\end{equation}
represents the midpoint of the time vehicle $i$ occupies the conflicted segment and
\begin{equation}
\beta_i  = \omega_i^{max} - \omega_i^{min}
\label{eq:beta}
\end{equation}
represents the range of the time either side of the midpoint, both scaled by a factor of two. 


In matrix form
\begin{equation}
\alpha_i  = \bm{f}^T \bm{\phi}_i + \bm{e}^T \bm{\phi}_i = \bm{1}_i^T\bm{A}{\phi}_i
\label{eq:alpha_m}
\end{equation}
with $\bm{A} = diag(\bm{f} + \bm{e})$
\begin{equation}
\beta_i  = \bm{f}^T \bm{\phi}_i - \bm{e}^T \bm{\phi}_i =  \bm{1}_i^T\bm{B}{\phi}_i
\label{eq:beta_m}
\end{equation}
with $\bm{B} = diag(\bm{f} - \bm{e})$

The resulting linear program (with parameters $\in\mathbb{R}$) has $p-1$ constraints as each AGV is only constrained by the preceding one.

\subsubsection{Quadratic Constraints}
\label{sec:quad_constraints}
Another way to treat the modulus operator in Equation \ref{eq:timing}, without forcing any particular arrival order is to square both sides as to give the expression in Equation \ref{eq:expanded}. 
\begin{equation}
\alpha_i^2 - \alpha_j^2 - 2 \alpha_i\alpha_j - (\beta_i^2 + \beta_j^2 +2 \beta_i \beta_j) > 0
\label{eq:expanded}
\end{equation}
Collecting terms by subscript gives
\begin{equation}
(\alpha_i^2 - \beta_i^2) - (\alpha_j^2 + \beta_j^2) - 2(\alpha_i\alpha_j + \beta_i \beta_j) > 0
\label{eq:collected}
\end{equation}

The matrix $\bm{\Lambda}_ij$ captures the constraints between a pair of vehicles and always contains four sub-matrices as shown in in Equation \ref{eq:lambda}. It is compatible with $\bm{\phi}_{i,j} = [\bm{\phi}_i^T, \bm{\phi}_j^T]^T$, containing only the relevant speeds for vehicles $i$ and $j$. 
\begin{equation}
\bm{\Lambda}_{ij} =\left[
	\begin{array}{cc}
\bm{\Lambda}_{ij}^{ii} & \bm{\Lambda}_{ij}^{ij} \\
\bm{\Lambda}_{ij}^{ji} & \bm{\Lambda}_{ij}^{jj} \\
	\end{array}
	\right]
\label{eq:lambda}
\end{equation}
Expanding 
\begin{multline}
\left[\bm{\phi}_i^T, \bm{\phi}_j^T\right]
 \left[\begin{array}{cc}
\bm{\Lambda}_{ij}^{ii} & \bm{\Lambda}_{ij}^{ij} \\
\bm{\Lambda}_{ij}^{ji} & \bm{\Lambda}_{ij}^{jj} \\
	\end{array}\right]
\left[\begin{array}{c}
\bm{\phi}_i\\
 \bm{\phi}_j \end{array} \right] \\
= \bm{\phi}_{i}^T \bm{\Lambda}_{ij}^{ii} \bm{\phi}_{i} + \bm{\phi}_{j}^T \bm{\Lambda}_{ij}^{jj} \bm{\phi}_{j} + \bm{\phi}_{i}^T \bm{\Lambda}_{ij}^{ij} \bm{\phi}_{j} + \bm{\phi}_{j}^T \bm{\Lambda}_{ij}^{ji} \bm{\phi}_{i}
\end{multline}
 makes it possible to compare terms with the scalar expression in Equation \ref{eq:collected}. This leads to the following expressions for the submatrices in $\Lambda$ in terms of $\alpha_i = \bm{1}_T\bm{A}_i\bm{\phi}_i$ and $\beta_i = \bm{1}_T\bm{B}_i\bm{\phi}_i$ 
\begin{equation}
\bm{\Lambda}_{ij}^{ii} = (\bm{A}_i - \bm{B}_i)\bm{1}_i\bm{1}_i^T(\bm{A}_i - \bm{B}_i) 
\label{eq:ii}
\end{equation}
\begin{equation}
\bm{\Lambda}_{ij}^{jj} = -(\bm{A}_j + \bm{B}_j)\bm{1}_j\bm{1}_j^T(\bm{A}_J + \bm{B}_j) 
\label{eq:jj}
\end{equation}
\begin{equation}
\bm{\Lambda}_{ij}^{ij} + \bm{\Lambda}_{ij}^{ij T} = -2(\bm{A}_j + \bm{B}_j)\bm{1}_j\bm{1}_i^T(\bm{A}_i + \bm{B}_i) 
\label{eq:ij}
\end{equation}

For more than two vehicles this can be arranged into a block diagonal matrix $\bm{H}_{ij}$ which is compatible with the input parameters, but still only represents the constraints between a pair. 

Expressed in this way it is clear the constraints are quadratic and it is trivial to differentiate twice to find the Hessian is the stack of constraint matrices $[\bm{H}_{ij}, \hdots]$. The objective is certainly convex as it is linear but the constraints may not be. If the Hessian of the constraints is positive semi-definite then they are convex and interior point methods will either find the global optimum or prove that there is no feasible solution \cite{Boyd2004}. The Hessian depends on the parameters of the roadmap, the number of approaching vehicles and their distance from the conflict. 

\subsubsection{Mixed Integer Constraints}
\label{sec:milp_constraints}
A third way of treating the timing constraint in Equation \ref{eq:timing}, also without forcing any particular arrival order involves splitting each constraint into two based on the sign of $(\alpha_i-\alpha_j)$ as shown in equation \ref{eq:or_cons}. Again, this is expressed in terms of the midpoint $\alpha_i$, $\alpha_j$ and extent $\beta_i$,$\beta_j$ of the time when vehicle $i$ and vehicle $j$ occupy the segment on their own path which passes through the conflict point,
\begin{equation}
\begin{array}{cc}
\alpha_i - \alpha_j > \beta_i + \beta_j &\textrm{if  }\alpha_i >\alpha_j  \\
\alpha_i - \alpha_j < -(\beta_i + \beta_j) & \textrm{otherwise}\\
\textrm{where } \alpha_i, \alpha_j, \beta_i, \beta_j >0
\end{array}
\label{eq:or_cons}
\end{equation}
In order to apply these OR constraints, an additional integer parameter $b_k$ can be introduced for each pair of AGV, along with an arbitrary large number $M$ as shown in Equation \ref{eq:big_m_cons}. 
\begin{equation}
\begin{array}{cc}
\alpha_i - \alpha_j + b_{i,j}M > \beta_i + \beta_j \\
\alpha_i - \alpha_j - (1-b_{i,j})M < -(\beta_i + \beta_j) \\
\textrm{where } b_{i,j}\in[0,1] \\
M>>\alpha_i, \alpha_j, \beta_i, \beta_j
\end{array}
\label{eq:big_m_cons}
\end{equation}
Now the problem is combinatorial rather than convex and appropriate methods must be used. These may be based on exhaustive search such as Branch-and-Bound, or solving a sequence of convex relaxations of the original problem \cite{Murray2010}. Combinatorial problems quickly become intractable for large numbers of variables, but in this case the underlying problem of arrival order is combinatorial, so exhaustive methods are needed to find the global minimum. 

It is possible to further assume every AGV travels at maximum speed once it reaches the conflict, simplifying equation Equations \ref{eq:alpha} and \ref{eq:beta} with a constant $p_i = g_i \phi_{min}$. 
\begin{equation}
\alpha_i = 2\omega_i^{min} + p_i
\end{equation}
\begin{equation}
\beta_i = p_i
\end{equation}
 where $g_i$ is the length of the conflicted segments in the plan of vehicle $i$. In this case Equation \ref{eq:big_m_cons} can be restated 
\begin{equation}
\begin{array}{cc}
\omega_i^{min} - \omega_j^{min} + b_{i,j}M > p_j \\
\omega_i^{min} - \omega_j^{min}  - (1-b_{i,j})M < -p_i \\
\textrm{where } b_{i,j}\in[0,1] \\
\end{array}
\label{eq:minlp}
\end{equation}

\section{Methods For Conflict Point Intersection}
For a intersection between roads with multiple lanes, it makes sense to plot the centreline of each lane, and the arc of each turning motion between lanes. Any point where two of these arcs cross is called a conflict point. By controlling arrival time at a conflict point, collisions can be avoided, while vehicles that do not pass the same conflict point can both proceed \cite{Levin2017}.

\begin{figure}[ht]
	\centering
	\includegraphics[width=0.9\linewidth]{plan_deadline_interface.eps}
	\caption{Key messages of the ``Plan/Deadline'' interface governing access to a conflict point intersection.}
	\label{fig:plan_deadline_interface}
\end{figure}

A controller based on a common heuristic for controlling access to a shared resource, the binary semaphore, is included for comparison with the optimal methods.  Similar approaches are widespread in AGV control \cite{Duinkerken1999} and \cite{Lee2019}.
 
  
\subsection{Semaphore Approach}
 To implement the ``plan/deadline'' interface, a binary semaphore for each conflict point was needed. The semaphore controller does not compute the entry and exit times of the conflict as it has is no model of the vehicle dynamics. It simply raises the semaphore, sending a ``full speed ahead'' message to the closest AGV to the intersection and a position deadline to all others.
 
 For this reason the deadline message contains the position at which the agv must stop, without any timing. The AGV must stop at the given position until it receives a 'proceed' message form the intersection controller.
 
 \section{Performance Comparison}
 Both conflict point representation and the zone representation are identical if the intersection has exactly one conflict. On this basis the semaphore approach and two versions of minimum crossing time optimal control, one with FIFO linear constraints and the other with quadratic constraints were compared on a simulated intersection comprising two lanes which cross in the middle. The approach distance is fixed at 15 metres.
 
The controllers will be tested with traffic levels and control latencies intended to bound the likely values of these parameters, shown in Table \ref{tab:test_params}.

 \begin{table}
	\caption{Parameters bounds used to generate test scenarios.}
	\label{tab:test_params} 
	\centering
	\begin{tabular}{ |c|c|c| }
		\hline
		Parameter & High Bound & Low Bound \\
		$T_C$ [s]& 0.5 & 0.1 \\ 
		$\frac{1}{\lambda}=\Delta T_a$ [s]& 10 & 2 \\ 	
		\hline
	\end{tabular}
\end{table}

\begin{table}
	\begin{tabular}{|c|c|c|c|}
		\hline
		& $\lambda_1$ & $\lambda_2$ & $f$ \\
		\hline
		HLHT & 0.5 & 0.5 & 2 \\
		HLMT & 0.1 & 0.5 & 2 \\
		HLLT & 0.1 & 0.1 & 2 \\
		LLHT & 0.5 & 0.5 & 10 \\
		LLMT & 0.1 & 0.5 & 10 \\
		LLLT & 0.1 & 0.1 & 10 \\
		\hline
	\end{tabular}
	\label{tab:params}
	\caption{Parameters for test scenarios. All units s$^-1$. Each scenario is identified with the first two characters relating to the latency between periodic messages from the intersection controller where High Latency is 500ms and  Low Latency is 100ms and the second two relating to the arrival rate, where High Traffic has $\lambda$=10 arrivals per second on both approaches, Low Traffic has $\lambda$=2 arrivals per second on both, and Mixed Traffic has one lane with $\lambda_1$=10 and the other with $\lambda_2$=2. For example High Latency, High Traffic becomes HLHT.}
\end{table}

\section{Simulation Results}
\begin{figure}
	\includegraphics[width=1.0\linewidth]{RunIC-FIFO-1611163493_315159.eps}
\label{fig:fifo_hlht}
\caption{...}
\end{figure}
\begin{figure}
	\includegraphics[width=1.0\linewidth]{RunIC-QuadConstr-1611164371_2017512.eps}
	\label{fig:quad_hlht}
	\caption{...}
\end{figure}